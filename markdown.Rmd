---
title: "Homework 5"
author: "Vincent Tam"
date: "November 3, 2018"
output: github_document
---

```{r Problem 1, setup, echo = FALSE, message = FALSE, warning = FALSE, error = FALSE}
library(tidyverse, rvest)
library(janitor)
library(dplyr, purrr, ggplot)
library(data.table)
conexp = data_frame(ArmID = list.files(path = "data")) %>%
  mutate(ArmID = as.character(ArmID)) %>%
  mutate(ArmID = str_replace(ArmID, ".csv", "")) %>%
  mutate(ArmID = str_replace(ArmID, "_", ""))
data = map(list.files(path = "data", full.names = TRUE), read_csv, col_names = TRUE) 
data = bind_rows(data, .id = NULL) 
complete = bind_cols(conexp, data) %>%
  clean_names() 
names(complete) <- gsub("\\_", "", names(complete))
complete
gather(complete, key = week, value = obs, week1:week8) %>%
ggplot(aes(week, obs, color = armid, group = armid)) + geom_point() + geom_line() + labs(title = "Control vs Experimental, Week 1-8", x = "Week", y = "Observations")
```
```{r Problem 2}
library(dplyr)
library(janitor)
library(purrr)
library(broom)
library(reshape)
X <- read.csv(url("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"))
X = 
  X %>%
  unite(city_state, city, state)
## summarize within cities to obtain total number of homicides and unsolved homicides
## purrr to subset using nest
## using MAP to loop in total homicides and unsolved homicides within each unique city/state
dispo = 
  X %>%
  select(city_state, disposition) 
total =
  dispo %>%
  group_by(city_state) %>%
  summarize(total_homicide = n())
homicides =
  dispo %>%
  filter(disposition == "Closed by arrest") %>%
  group_by(city_state) %>%
  summarize(total_solved = n())
unsolved =
  dispo %>%
  filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>%
  group_by(city_state) %>%
  summarize(total_unsolved = n())
## prop test for MD
baltimore_total =
  dispo %>%
  filter(city_state == "Baltimore_MD") 
total_baltimore = count(baltimore_total)
baltimore_solved =
  homicides %>%
  filter(city_state == "Baltimore_MD")
baltimore_unsolved = 
  unsolved %>%
  filter(city_state == "Baltimore_MD") 
baltimore_homicides = 
  merge(baltimore_unsolved, total_baltimore)
prop.test(baltimore_homicides$total_unsolved, baltimore_homicides$n)
## prop.test = unsolved/total
complete_table = 
  merge_recurse(list(total, unsolved, homicides)) 
complete_table[is.na(complete_table)] <- 0
homicide_prop <- function(total.prop, unsolved.prop) {
 result = broom::tidy(prop.test(total.prop, unsolved.prop))
 tibble(
   estimate = result %>% pull(estimate),
   conf_low = result %>% pull(conf.low), 
   conf_high = result %>% pull(conf.high))}
complete_table = as.data.frame(complete_table)
complete_table =
  complete_table %>% 
  mutate(homicide_prop = map2(unsolved, total, homicide_prop)) %>% 
  unnest()


## unnest(complete_table)
## complete_table =
## complete_table %>%
## as.tibble() %>%
## flatten_dbl(total_homicide)

## as.tibble(complete_homicidetable)
## names(complete_homicidetable)
```


